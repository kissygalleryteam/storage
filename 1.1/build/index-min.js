/*!build time : 2013-11-27 4:36:02 PM*/
KISSY.add("gallery/storage/1.1/conf",function(){var a=location.href.indexOf("if-debug=1")>-1,b=location.href.indexOf("if-debug-log=1")>-1,c="http://gm.mmstat.com",d="http://log.mmstat.com/ued.1.1.2?type=9&_gm:id=storage&v=1.1",e={DEBUG:a,DEBUG_LOG:b,SAM_PV:.001,TIMEOUT_STORAGE:3e3,PROXY:"http://a.tbcdn.cn/s/kissy/gallery/storage/1.1/proxy.html",PROXY_TMALL:"http://www.tmall.com/go/act/stp-tm.php",PROXY_TAOBAO:"http://www.taobao.com/go/act/stp-tb.php",XD_TOKEN:"__ga_xd_token",UID_FROM:"__ga_xd_from11",UID_TO:"__ga_xd_to11",M:{G:d+"&t=g",P:d+"&t=p"},ARR:{ST_SET:c+"/tmallbrand.999.5",ST_GET:c+"/tmallbrand.999.6",ST_RM:c+"/tmallbrand.999.7",ST_CL:c+"/tmallbrand.999.8"},K:{ONLOAD:"onload",PROXY:"proxy",PREFIX:"prefix",XD_TIMEOUT:"xdTimeout",IFRAME_TIMEOUT:"iframeTimeout",IFRAME:"iframe",TOKEN:"token",XD:"xd",CALLBACK_LIST:"callbackList",CACHED_ACTION_LIST:"cachedActionList",PROXY_READY:"proxyReady"}};return e}),KISSY.add("gallery/storage/1.1/util",function(a,b){var c={log:function(){b.DEBUG_LOG&&window.console&&window.console.log&&window.console.log.apply&&window.console.log.apply(window.console,arguments)},fm:function(){if(0==arguments.length)return"";if(1==arguments.length)return arguments[0];var a,b=arguments[0];for(a=1;a<arguments.length;++a){var c=new RegExp("\\{"+(a-1)+"\\}","g");b=b.replace(c,arguments[a])}return b}},d=c;d.sendLog=function(a){d.send(d.fm(b.M.G,encodeURIComponent(location.href))),d.send(a)},d.send=function(a){if(a){var b="__st_"+ +new Date+Math.random(),c=new Image;window[b]=c,c.src=d.fm("{0}{1}r{2}=1",a,a.indexOf("?")>-1?"&":"?",+new Date),c.onload=function(){window[b]=null}}};var e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return d.getRndStr=function(a){for(var b,c=[],d=e.length,f=0;a>f;++f)b=e.charAt(Math.floor(Math.random()*d)),c.push(b);return c.join("")},d},{requires:["./conf"]}),KISSY.add("gallery/storage/1.1/xd",function(a,b,c,d){function e(){r?q.addEventListener?addEventListener("message",f,!1):q.attachEvent&&attachEvent("onmessage",f):u.onMessage(f)}function f(b){var e={};try{e=c.parse(b.data)}catch(f){return}var g=e[d.XD_TOKEN];a.each(t,function(a){if(g===a.get(j)&&d.UID_FROM in e&&d.UID_TO in e){var b=e[d.UID_TO];if(b){var c=s[b];if(clearTimeout(c),s[b]=0,!c)return}a.get(i)(e)}})}function g(a){var b=this;b._opt=a,t.push(b)}var h=0,i="receive",j="token",k="target",l="timeout",m="iframeTimeout",n=10,o=10,p=3e3,q=window,r=q.postMessage,s={},t=[],u={uid:0,hid:-1,q:[],tm:0,postMessage:function(a,b){var c=++u.uid,d=u.q,e={name:+new Date+""+c+"^"+document.domain+"&"+b,uid:c,target:a};d.push(e),u.tm||(u.tm=setInterval(function(){var a=u.q;if(!(0===a.length||a[0].uid<=u.hid)){var b=a[0];u.hid=b.uid,b.target.name=b.name}},o))},onMessage:function(a){function b(){var b=q.name;if(b!==c){u.q.shift(),c=b;var e=d.exec(b);if(!e)return;var f={origin:e[2],data:e[3]};a&&a(f)}}var c="",d=/^(\d+?)\^(.+?)&(.*?)$/;setInterval(b,n)}};return e(),a.augment(g,{send:function(b,e,g){function i(){var a={};a.origin="*";var e={};e.c=b.c||"",e[d.XD_TOKEN]=b[d.XD_TOKEN]||"",e[d.UID_FROM]=0,e[d.UID_TO]=0,a.data=c.stringify(e),f(a)}if(a.isObject(b)){var n=this,o=n.get(k),q=n.get(l)||p,t=++h;e=e||"*",b[d.XD_TOKEN]=n.get(j),b[d.UID_TO]=b[d.UID_FROM]||0,b[d.UID_FROM]=t;var v=c.stringify(b);g||(s[t]=setTimeout(function(){s[t]=0,i()},q)),n.get(m)?i():r?o.postMessage(v,e):u.postMessage(o,v,e)}},get:function(a){return this._opt[a]},set:function(a,b){this._opt[a]=b}}),g},{requires:["event","json","./conf","./util"]}),KISSY.add("gallery/storage/1.1/index",function(a,b,c,d,e,f){if(window.__KS_STORAGE11)return window.__KS_STORAGE11;var g={},h=0,i=function(b){var c=this;b=b||{},b.token=+new Date+e.getRndStr(8);var f=b.proxy||d.PROXY;switch(f=e.fm("{0}{1}{2}={3}",f,f.indexOf("?")>-1?"&":"?",d.XD_TOKEN,b.token)){case"tmall":f=d.PROXY_TMALL;break;case"taobao":f=d.PROXY_TAOBAO;break;case"common":f=d.PROXY}b.proxy=f,b.prefix=b.prefix||"",c._opt=a.merge(g,b),c.init()};return a.augment(i,{init:function(){function b(b){g.setConf(d.K.PROXY_READY,!0);var c=new f({target:h.contentWindow,token:g.getConf(d.K.TOKEN),iframeTimeout:b,timeout:g.getConf(d.K.XD_TIMEOUT),receive:function(a){var b=g.getConf(d.K.CALLBACK_LIST),c=b[a.c];if(c){c(a.v);try{delete b[a.c]}catch(e){}}}});g.setConf(d.K.XD,c);var e=g.getConf(d.K.CACHED_ACTION_LIST);a.each(e,function(a){c.send(a,"*")}),g.setConf(d.K.CACHED_ACTION_LIST,[]);var i=g.getConf(d.K.ONLOAD);i&&i()}function c(){e.log("storage proxy loaded"),clearTimeout(j),j&&setTimeout(function(){b(!1)},100)}var g=this;g.setConf(d.K.CALLBACK_LIST,{}),g.setConf(d.K.CACHED_ACTION_LIST,[]),g.setConf(d.K.PROXY_READY,!1);var h=document.createElement("iframe"),i=h.style;i.display="none";var j=-1;j=setTimeout(function(){j=0,b(!0)},g.getConf(d.K.IFRAME_TIMEOUT)||d.TIMEOUT_STORAGE),h.src=g.getConf(d.K.PROXY),h.attachEvent?h.attachEvent("onload",c):h.onload=c,document.body.appendChild(h)},send:function(b){var c=this,e=c.getConf(d.K.CALLBACK_LIST),f=c.getConf(d.K.CACHED_ACTION_LIST),g=c.getConf(d.K.PROXY_READY),i=c.getConf(d.K.PREFIX);if(b.p=i,a.isFunction(b.success)){var j="token"+ ++h;b.c=j,e[j]=b.success;try{delete b.success}catch(k){}}if(!g)return f.push(b),void 0;var l=c.getConf(d.K.XD);l&&l.send(b)},get:function(a){a=a||{},a.m="get",this.send(a),Math.random()<d.SAM_PV&&e.sendLog(d.ARR.ST_GET)},set:function(a){a=a||{},a.m="set",this.send(a),Math.random()<d.SAM_PV&&e.sendLog(d.ARR.ST_SET)},remove:function(a){a=a||{},a.m="remove",this.send(a),Math.random()<d.SAM_PV&&e.sendLog(d.ARR.ST_RM)},clear:function(a){a=a||{},a.m="clear",this.send(a),Math.random()<d.SAM_PV&&e.sendLog(d.ARR.ST_CL)},getConf:function(a){return this._opt[a]},setConf:function(a,b){this._opt[a]=b}}),window.__KS_STORAGE11=i,i},{requires:["event","json","./conf","./util","./xd"]});